<!DOCTYPE html>
<html>
    <head>
        <title>Locationator2000</title>

        <script src="./papaparse.min.js"></script>
        <script src="./loader.js"></script>
        <script src="./quadtree.js"></script>
        <script src="./world_map.js"></script>

        <script>
            let coords;
            let map;

            function setupMap() {
                L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '&copy; <a href="http://openstreemap.org/copyright">OpenStreetMap</a>'
                }).addTo(map);
            }

            function loadMap() {
                if("geolocation" in navigator) {
                    navigator.geolocation.getCurrentPosition(pos => {
                        coords = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                        map = L.map('map').setView([pos.coords.latitude, pos.coords.longitude], 5);
                        setupMap();
                    })
                }
                else {
                    coords = { lat: 0, lon: 0 };
                    map = L.map('map').setView([0, 0], 5);
                    setupMap();
                }
            }

            async function search() {
                let qt = new Quadtree();
                let wm = new world_map();

                for await(const { lat, lon } of loadFromUrl("./ufo_sightings.csv")) {
                    qt.insert(lat, lon, "UFO");
                    wm.insert("UFO", lat, lon);
                }

                for(const point of qt.findn(coords.lat, coords.lon, 10)) {
                    let marker = L.marker([point.lat, point.lon]).addTo(map);
                    marker.bindPopup(point.data).openPopup();
                }
            }

            window.onload = () => {
                document.getElementById('btn').addEventListener('click', search);
                loadMap();
            }
        </script>

        <style>
            #map {
                width: 800px;
                height: 600px;
            }
        </style>
        
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    </head>

    <body>
        <button id="btn">Run</button>

        <div id="map"></div>
    </body>
</html>